template(name="message")
  if group
    +submessage
    if orphanCount
      .orphans
        h3
          span(data-toggle="tooltip", title="Orphan subthreads are caused by someone deleting a message that has (undeleted) children, which become orphans.  You can reparent these orphans to have a valid parent, or delete them, or ask the author or a superuser to undelete the original parent.") #{orphanCount}:
        each orphans
          +submessage
  else
    +badMessage

template(name="badMessage")
  p The message &ldquo;<b>#{message}</b>&rdquo; does not exist or you do not have permission to access it.
  unless currentUser
    p You probably need to log in.

template(name="submessage")
  .panel.panel-primary.message
    .panel-heading
      unless history
        if editingRV
          input.form-control.title(type="text", placeholder="Title", value="{{title}}", style="width: 100%")
      .space-between
        .unit
          unless editingRV
            button.btn.btn-xs.btn-info.foldButton(aria-label="Fold")
              if folded
                span.glyphicon.glyphicon-plus(aria-hidden="true")
              else
                span.glyphicon.glyphicon-minus(aria-hidden="true")
            button.btn.btn-xs.btn-info.focusButton(aria-label="Focus")
              span.glyphicon.glyphicon-new-window(aria-hidden="true")
            span.space
            span.title.tex2jax= title
            span.space
          if deleted
            span.label.label-danger Deleted
          else
            unless published
              span.label.label-warning Unpublished
        .unit
          if history
            button.btn.btn-default.historyButton Stop History
          else
            if editingRV
              button.btn.btn-default.editButton Stop Editing
              .btn-group
                button.btn.btn-default.dropdown-toggle(type="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
                  | #{keyboard}
                  span.caret
                ul.dropdown-menu(role="menu")
                  li.editorKeyboard(class="{{activeKeyboard 'ace'}}")
                    a(href="#",data-keyboard="ace") Ace
                  li.editorKeyboard(class="{{activeKeyboard 'vim'}}")
                    a(href="#",data-keyboard="vim") Vim
                  li.editorKeyboard(class="{{activeKeyboard 'emacs'}}")
                    a(href="#",data-keyboard="emacs") Emacs
              +formatSelector
            else
              unless folded
                button.btn.btn-default.historyButton History
                if canEdit
                  unless isFile
                    button.btn.btn-default.editButton Edit
                  else
                    // In future, support basic image editing.  For now, just:
                    +messageReplace
            if deleted
              if canUndelete
                button.btn.btn-success.deleteButton Undelete
              if canSuperdelete
                button.btn.btn-danger.superdeleteButton Superdelete
            else
              if published
                if canUnpublish
                  button.btn.btn-danger.publishButton Unpublish
              else
                if canPublish
                  button.btn.btn-success.publishButton Publish
              if canDelete
                button.btn.btn-danger.deleteButton Delete
    unless folded
      if history
        +messageHistory forHistory
      else
        with nothing
          if editingRV
            //+sharejsAce docid=editingRV
            +sharejsAce docid=editingNR onRender=config
      .panel-body(class=tex2jax) !{body}
      table.message-footer
        tr
          td
            if canReply
              button.btn.btn-default.replyButton Reply
            if canAttach
              +messageAttach
          td.author
            if published
              | (posed by
            else
              | (created by
            | #{creator} {{formatDate created}}#{authors})
      .children
        each children
          +submessage
      if children
        .panel-body.panel-secondbody
          if canReply
            button.btn.btn-default.replyButton Reply
          if canAttach
            +messageAttach

template(name="formatSelector")
  .btn-group
    button.btn.btn-default.dropdown-toggle(type="button", data-toggle="dropdown", aria-haspopup="true", aria-expanded="false")
      if format
        | {{capitalize format}}
      else
        | ?
      span.caret
    ul.dropdown-menu(role="menu")
      each formats
        li.editorFormat(class="#{active}")
          a(href="#",data-format=format)= capitalized

template(name="superdelete")
  .modal
    .modal-dialog
      .modal-content
        .modal-header
          h2 Confirm Superdelete
        .modal-body
          p Are you sure you want to delete &ldquo;#{title}&rdquo; (#{_id}) by #{creator}?
          p Superdelete destroys all logs of the message ever existing and cannot be undone.  Use only for silly mistakes.
        .modal-footer
          button.btn.btn-warning.shallowSuperdeleteButton Superdelete node, not children
          button.btn.btn-danger.deepSuperdeleteButton Recursively superdelete node and children
          button.btn.btn-success.cancelButton.fullwidth Cancel

template(name="messageHistory")
  //.tex2jax !{body}
  .historySlider
    input(type="text", style="display: none")

template(name="messageAttach")
  input.attachInput(type="file", style="display:none", multiple)
  button.btn.btn-default.attachButton Attach

template(name="messageReplace")
  input.replaceInput(type="file", style="display:none")
  button.btn.btn-default.replaceButton Replace
